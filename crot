#!/bin/bash

# READ AUTH
if [ -f "/root/auth" ]; then
    IFS=$'\n' read -d '' -r -a lines < "/root/auth"
    if [ "${#lines[@]}" -ge 2 ]; then
        BOT_TOKEN="${lines[0]}"
        CHAT_ID="${lines[1]}"
    else
        echo "El archivo de autenticaciÃ³n debe tener al menos 2 lÃ­neas (su token y su ID de chat)."
        exit 1
    fi
else
    echo "Archivo de autenticaciÃ³n no encontrado."
    exit 1
fi

# FunciÃ³n para enviar mensajes a los bots de Telegram
send_telegram_message() {
    chat_id="$1"
    message="$2"
    curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" -d "chat_id=$chat_id&text=$message" > /dev/null
}

# Funcion para recolectar datos de vnstat (en algunos casos necesario cambiar la interfaz de red, se consulta usando ip -a)
get_daily_bandwidth() {
    vnstat_day=$(vnstat -i ens3 -d 1 --style 0 | sed -n 6p)
    vnstat_month=$(vnstat -i ens3 -m 1 --style 0 | sed -n 6p)
    vnstat_year=$(vnstat -i ens3 -y 1 --style 0 | sed -n 6p)
    down_day=$(echo "$vnstat_day" | awk '{print $5, $6}')
    down_month=$(echo "$vnstat_month" | awk '{print $5, $6}')
    down_year=$(echo "$vnstat_year" | awk '{print $5, $6}')
    up_day=$(echo "$vnstat_day" | awk '{print $2, $3}')
    up_month=$(echo "$vnstat_month" | awk '{print $2, $3}')
    up_year=$(echo "$vnstat_year" | awk '{print $2, $3}')
    total_day=$(echo "$vnstat_day" | awk '{print $8, $9}')
    total_month=$(echo "$vnstat_month" | awk '{print $8, $9}')
    total_year=$(echo "$vnstat_year" | awk '{print $8, $9}')
    
    echo "
â•”â•â• ğŸ“Š ğ—œğ—¡ğ—™ğ—¢ğ—¥ğ— ğ—˜ ğ——ğ—˜ ğ—§ğ—¥ğ—”ğ—™ğ—œğ—–ğ—¢ ğ—©ğ—£ğ—¦ ğŸ“Š
â•‘
â•  â›±ï¸ ğ—˜ğ—§ğ—›ğŸµğŸ³ğŸ¯ â˜ ğ—§ğ—²ğ—®ğ—ºğ—©ğŸ®ğŸ° ğŸ”¥
â•  ğŸš€ ğ—˜ğ—¦ğ—§ğ—”ğ——ğ—¢ â˜ ğ—˜ğ—¡ ğ—Ÿğ—œğ—¡ğ—˜ğ—”âœ…
â•‘
â• â•â• ğ—¨ğ—¦ğ—¢ ğ——ğ—œğ—”ğ—¥ğ—œğ—¢  ğŸ“†
â•  ğŸ“¥ $down_day | ğŸ“¤ $up_day
â•  ğŸ“Š ğ—§ğ—¢ğ—§ğ—”ğ—Ÿ â˜ $total_day
â•‘
â• â•â• ğ—¨ğ—¦ğ—¢  ğ— ğ—˜ğ—¡ğ—¦ğ—¨ğ—”ğ—Ÿ ğŸ“†
â•  ğŸ“¥  $down_month |  ğŸ“¤ $up_month
â•  ğŸ“Š ğ—§ğ—¢ğ—§ğ—”ğ—Ÿ â˜ $total_month
â•‘
â• â•â• ğ—¨ğ—¦ğ—¢ ğ—”ğ—¡ğ—¨ğ—”ğ—Ÿ ğŸ“†
â•  ğŸ“¥  $down_year  |  ğŸ“¤ $up_year
â•  ğŸ“Š ğ—§ğ—¢ğ—§ğ—”ğ—Ÿ â˜ $total_year
â•‘
â•  âš ï¸ ğ—”ğ—–ğ—§ğ—¨ğ—”ğ—Ÿğ—œğ—­ğ—”ğ—–ğ—œğ—¢ğ—¡ ğ—”ğ—¨ğ—§ğ—¢ğ— ğ—”ğ—§ğ—œğ—–ğ—” ğ—˜ğ—¡ ğ—›ğ—¢ğ—¥ğ—”ğ—¥ğ—œğ—¢ ğ—˜ğ—¦ğ—§ğ—”ğ—•ğ—Ÿğ—˜ğ—–ğ—œğ——ğ—¢ âš ï¸
â•‘
â•š â° ğ—¨ğ—Ÿğ—§ğ—œğ— ğ—” ğ—”ğ—–ğ—§ğ—¨ğ—”ğ—Ÿğ—œğ—­ğ—”ğ—–ğ—œğ—¢ğ—¡: $(date +'%d-%m-%Y %I:%M %p')
"
}

# Programa principal
bandwidth_message=$(get_daily_bandwidth)

# Enviar mensajes a cuentas personales de Telegram
send_telegram_message "$CHAT_ID" "$bandwidth_message"

# Recibir mensaje desde bot
if [[ "$message" == "crot" ]]; then 
send_telegram_message "$CHAT_ID" "$(get_daily_bandwidth)"; 
fi
